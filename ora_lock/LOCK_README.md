
oracle 锁处理工具

修订记录

| 作者 | 版本 | 时间       | 备注       |
| ---- | ---- | ---------- | ---------- |
| 张全针 | v1.0 | 2020/04/03 | 添加锁处理功能|
| 张全针 | v1.1 | 2020/04/13 | 优化输出显示|


## 定位
        给MC公司内部人员使用，提供自动化运维功能，提高工作效率


## 先决条件

        1.执行环境与目标环境打通ssh连接
        2.执行环境需存在Oracle客户端client libraries（若已存在oracle环境也可以）

## 支持的操作系统和数据库版本配对
        操作系统支持：rehl5，rehl6，rehl7
        数据库版本支持：Oracle10g单机及RAC,Oracle11g单机及RAC,Oracle 12c-19c 非CDB单机及rac
        后续待适配：pdb实例




## 使用说明




### python运行环境

python 3


        1. 进入脚本目录
        pip install -r requirements.txt    #安装项目python依赖包cx_Oracle,prettytable与paramiko。  #第一次安装时用

        如果网速慢，可以用以下命令安装，使用国内的PIP源

   ```cx_Oracle
   pip install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt
   ```




## 代码说明

| 文件或目录       | 功能                 | 备注                                                         |
| --------------- | -------------------- | ------------------------------------------------------------ |
| ora_ops.py      | 命令行主入口         |                                                             |
| method.py       | 主要功能和函数方法    |                                                              |
| ora_ops.log     | 安装脚本输出结果日志  |                                                              |

## 主程序的使用
python ora_ops.py

### 命令行参数介绍

          optional arguments:
          -h, --help            show this help message and exit
          -c CONN_STR, --conn_str CONN_STR
                              输入你的数据库连接串：用户名/密码@ip:端口/服务名
          -m MODE, --mode MODE  数据库连接方式，可填'sysdba'或'default_auth',默认为'default_auth'
        
          -i {check_instance,check_lock}, --item {check_instance,check_lock}
                              check_instance:检查数据库
                              check_lock:数据库锁检查

### 锁处理功能使用举例

#### 1.在11g rac环境上检查锁信息，完整输出示例

     python ora_ops.py -c sys/oracle@192.168.238.35:1521/ora11g -i check_lock

        ###检查数据库信息:
        +---------+---------------+--------+------------+
        | INST_ID | INSTANCE_NAME | STATUS |  VERSION   |
        +---------+---------------+--------+------------+
        |    1    |    ora11g1    |  OPEN  | 11.2.0.4.0 |
        +---------+---------------+--------+------------+
        |    2    |    ora11g2    |  OPEN  | 11.2.0.4.0 |
        +---------+---------------+--------+------------+

        ###锁下游会话信息:
        +---------+-----+---------+----------+------------------+-------------------------------+----------------------------------+---------+---------------+------------------------------------+
        | INST_ID | SID | SERIAL# | USERNAME | BLOCKING_SESSION |             EVENT             |             PROGRAM              | MACHINE |     SQL_ID    |              SQL_TEXT              |
        +---------+-----+---------+----------+------------------+-------------------------------+----------------------------------+---------+---------------+------------------------------------+
        |    1    | 814 |  16135  |   SYS    |       868        | enq: TX - row lock contention | sqlplus.mchz@11grac1 (TNS V1-V3) | 11grac1 | 0pzga1c2yn7a7 | update zqz.t1 set id=2 where id =1 |
        +---------+-----+---------+----------+------------------+-------------------------------+----------------------------------+---------+---------------+------------------------------------+

        ###锁对象信息:
        +---------+-------+-------------+-------------+---------------+----------------+-----------------+---------------+
        | INST_ID | OWNER | OBJECT_NAME | OBJECT_TYPE | ROW_WAIT_OBJ# | ROW_WAIT_FILE# | ROW_WAIT_BLOCK# | ROW_WAIT_ROW# |
        +---------+-------+-------------+-------------+---------------+----------------+-----------------+---------------+
        |    1    |  ZQZ  |      T1     |    TABLE    |     107216    |       4        |      23327      |       0       |
        +---------+-------+-------------+-------------+---------------+----------------+-----------------+---------------+

        ###锁阻塞源头会话信息:
        +---------+-----+---------+-------+----------+----------------------------+-----------------------------+
        | INST_ID | SID | SERIAL# |  SPID | USERNAME |          PROGRAM           |            EVENT            |
        +---------+-----+---------+-------+----------+----------------------------+-----------------------------+
        |    1    | 868 |  11813  | 12562 |  oracle  | oracle@11grac1 (TNS V1-V3) | SQL*Net message from client |
        +---------+-----+---------+-------+----------+----------------------------+-----------------------------+

        ###锁阻塞源头会话回滚段信息:
        +---------+-----+-------+----------+-----------------------+-----------+-----------+
        | INST_ID | SID | XACTS | USERNAME |          NAME         | USED_UBLK | USED_UREC |
        +---------+-----+-------+----------+-----------------------+-----------+-----------+
        |    1    | 868 |   1   |   SYS    | _SYSSMU10_1197734989$ |     1     |     1     |
        +---------+-----+-------+----------+-----------------------+-----------+-----------+
        如果你想杀掉该阻塞会话进程,可以使用以下两种方法的其中一种:

        (1).操作系统层面kill进程：

        在节点1的环境中执行命令:
        kill -9 12562

        (2).在数据库指定节点中执行以下sql来杀掉该阻塞会话:

        在节点1的数据库中执行SQL命令:
        alter system kill session'868,11813,@1' immediate;